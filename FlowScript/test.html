<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow區塊鏈獎勵監控面板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
        }

        .info-value {
            color: #2c3e50;
            font-weight: 500;
            word-break: break-all;
        }

        .amount {
            color: #27ae60;
            font-weight: bold;
            font-size: 1.1em;
        }

        .node-id {
            font-family: monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status.loading {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .status.success {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .hidden {
            display: none;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .api-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .api-endpoint {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Flow區塊鏈獎勵監控面板</h1>
            <p>追蹤TWM節點的獎勵發放情況</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="fetchLatestReward()">🔄 獲取最新獎勵</button>
            <button class="btn" onclick="fetchNodeInfo()">📊 獲取節點資訊</button>
            <button class="btn" onclick="fetchDelegatorInfo()">👥 獲取委託人資訊</button>
        </div>

        <div id="status" class="status hidden">
            <div class="loading-spinner hidden" id="spinner"></div>
            <div id="status-text"></div>
        </div>

        <div class="dashboard">
            <div class="card" id="reward-card">
                <h3>
                    <div class="card-icon">💰</div>
                    最新獎勵資訊
                </h3>
                <div id="reward-info">
                    <div class="info-row">
                        <span class="info-label">狀態:</span>
                        <span class="info-value">等待載入...</span>
                    </div>
                </div>
            </div>

            <div class="card" id="node-card">
                <h3>
                    <div class="card-icon">🖥️</div>
                    節點資訊
                </h3>
                <div id="node-info">
                    <div class="info-row">
                        <span class="info-label">狀態:</span>
                        <span class="info-value">等待載入...</span>
                    </div>
                </div>
            </div>

            <div class="card" id="delegator-card">
                <h3>
                    <div class="card-icon">👥</div>
                    委託人資訊
                </h3>
                <div id="delegator-info">
                    <div class="info-row">
                        <span class="info-label">狀態:</span>
                        <span class="info-value">等待載入...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="api-info">
            <h3>🔌 API端點資訊</h3>
            <p><strong>本地獎勵API:</strong></p>
            <div class="api-endpoint">GET http://localhost:8080/api/reward</div>
            
            <p><strong>Flow區塊鏈API:</strong></p>
            <div class="api-endpoint">POST https://rest-mainnet.onflow.org/v1/scripts?blocks_height=final</div>
            
            <p><strong>監控節點ID:</strong></p>
            <div class="api-endpoint">e8f4bd649d08ecb5afb7023a0c5e8bb10ce56659399665da8cc9d517e7982f92</div>
        </div>
    </div>

    <script>
        // 全局變數
        const TWM_NODE_ID = "e8f4bd649d08ecb5afb7023a0c5e8bb10ce56659399665da8cc9d517e7982f92";
        const FLOW_API_URL = "https://rest-mainnet.onflow.org/v1/scripts?blocks_height=final";
        const LOCAL_REWARD_API = "http://localhost:8080/api/reward";

        // 顯示狀態訊息
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            const spinner = document.getElementById('spinner');
            
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            statusText.textContent = message;
            
            if (type === 'loading') {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        // 隱藏狀態訊息
        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
        }

        // 格式化數字
        function formatNumber(num) {
            return parseFloat(num).toLocaleString('zh-TW', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 8
            });
        }

        // 格式化節點ID（縮短顯示）
        function formatNodeId(nodeId) {
            return nodeId.substring(0, 8) + '...' + nodeId.substring(nodeId.length - 8);
        }

        // 獲取最新獎勵（從本地API）
        async function fetchLatestReward() {
            showStatus('正在獲取最新獎勵資訊...', 'loading');
            
            try {
                const response = await fetch(LOCAL_REWARD_API);
                
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                displayRewardInfo(data);
                showStatus('獎勵資訊更新成功！', 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('獲取獎勵資訊失敗:', error);
                showStatus(`獲取獎勵失敗: ${error.message}`, 'error');
                
                // 如果本地API失敗，顯示模擬數據
                displayRewardInfo({
                    blockHeight: "模擬數據",
                    nodeID: TWM_NODE_ID,
                    delegatorID: null,
                    amount: "123.45678901",
                    eventType: "A.8624b52f9ddcd04a.FlowIDTableStaking.RewardsPaid",
                    timestamp: new Date().toLocaleString('zh-TW')
                });
                
                setTimeout(hideStatus, 5000);
            }
        }

        // 顯示獎勵資訊
        function displayRewardInfo(data) {
            const rewardInfo = document.getElementById('reward-info');
            
            rewardInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">區塊高度:</span>
                    <span class="info-value">${data.blockHeight}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">節點ID:</span>
                    <span class="info-value node-id">${formatNodeId(data.nodeID)}</span>
                </div>
                ${data.delegatorID ? `
                <div class="info-row">
                    <span class="info-label">委託人ID:</span>
                    <span class="info-value">${data.delegatorID}</span>
                </div>` : ''}
                <div class="info-row">
                    <span class="info-label">獎勵金額:</span>
                    <span class="info-value amount">${formatNumber(data.amount)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">事件類型:</span>
                    <span class="info-value">${data.eventType ? data.eventType.split('.').pop() : 'RewardsPaid'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">時間戳:</span>
                    <span class="info-value">${data.timestamp || '未知'}</span>
                </div>
            `;
        }

        // 獲取節點資訊
        async function fetchNodeInfo() {
            showStatus('正在獲取節點資訊...', 'loading');
            
            try {
                const response = await fetch('http://localhost:8080/api/node');
                
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                displayNodeInfo(data);
                showStatus('節點資訊更新成功！', 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('獲取節點資訊失敗:', error);
                showStatus(`獲取節點資訊失敗: ${error.message}`, 'error');
                
                // 顯示模擬數據
                displayNodeInfo({
                    value: {
                        id: TWM_NODE_ID,
                        networkingAddress: "示例網路地址",
                        networkingKey: "示例網路金鑰",
                        role: 1,
                        tokensStaked: "500000.00000000",
                        tokensCommitted: "500000.00000000",
                        tokensUnstaking: "0.00000000",
                        tokensUnstaked: "0.00000000"
                    }
                });
                
                setTimeout(hideStatus, 5000);
            }
        }

        // 顯示節點資訊
        function displayNodeInfo(data) {
            const nodeInfo = document.getElementById('node-info');
            const nodeData = data.value || data;
            
            nodeInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">節點ID:</span>
                    <span class="info-value node-id">${formatNodeId(nodeData.id || TWM_NODE_ID)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">角色:</span>
                    <span class="info-value">${nodeData.role || '未知'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">已質押代幣:</span>
                    <span class="info-value amount">${formatNumber(nodeData.tokensStaked || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">承諾代幣:</span>
                    <span class="info-value amount">${formatNumber(nodeData.tokensCommitted || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">解除質押中:</span>
                    <span class="info-value amount">${formatNumber(nodeData.tokensUnstaking || 0)} FLOW</span>
                </div>
            `;
        }

        // 獲取委託人資訊
        async function fetchDelegatorInfo() {
            showStatus('正在獲取委託人資訊...', 'loading');
            
            try {
                const response = await fetch('http://localhost:8080/api/delegator');
                
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                displayDelegatorInfo(data);
                showStatus('委託人資訊更新成功！', 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('獲取委託人資訊失敗:', error);
                showStatus(`獲取委託人資訊失敗: ${error.message}`, 'error');
                
                // 顯示模擬數據
                displayDelegatorInfo({
                    value: {
                        id: 1,
                        nodeID: TWM_NODE_ID,
                        tokensCommitted: "1000.00000000",
                        tokensStaked: "1000.00000000",
                        tokensUnstaking: "0.00000000",
                        tokensUnstaked: "0.00000000",
                        tokensRewarded: "50.12345678"
                    }
                });
                
                setTimeout(hideStatus, 5000);
            }
        }

        // 顯示委託人資訊
        function displayDelegatorInfo(data) {
            const delegatorInfo = document.getElementById('delegator-info');
            const delegatorData = data.value || data;
            
            delegatorInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">委託人ID:</span>
                    <span class="info-value">${delegatorData.id || '1'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">目標節點:</span>
                    <span class="info-value node-id">${formatNodeId(delegatorData.nodeID || TWM_NODE_ID)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">承諾代幣:</span>
                    <span class="info-value amount">${formatNumber(delegatorData.tokensCommitted || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">已質押代幣:</span>
                    <span class="info-value amount">${formatNumber(delegatorData.tokensStaked || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">累計獎勵:</span>
                    <span class="info-value amount">${formatNumber(delegatorData.tokensRewarded || 0)} FLOW</span>
                </div>
            `;
        }

        // 頁面載入時自動獲取獎勵資訊
        window.addEventListener('load', () => {
            fetchLatestReward();
        });

        // 每30秒自動刷新獎勵資訊
        setInterval(fetchLatestReward, 30000);
    </script>
</body>
</html>