<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowå€å¡Šéˆçå‹µç›£æ§é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
        }

        .info-value {
            color: #2c3e50;
            font-weight: 500;
            word-break: break-all;
        }

        .amount {
            color: #27ae60;
            font-weight: bold;
            font-size: 1.1em;
        }

        .node-id {
            font-family: monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .status {
            text-align: center;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-weight: 600;
        }

        .status.loading {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .status.success {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .hidden {
            display: none;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .api-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .api-endpoint {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Flowå€å¡Šéˆçå‹µç›£æ§é¢æ¿</h1>
            <p>è¿½è¹¤TWMç¯€é»çš„çå‹µç™¼æ”¾æƒ…æ³</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="fetchLatestReward()">ğŸ”„ ç²å–æœ€æ–°çå‹µ</button>
            <button class="btn" onclick="fetchNodeInfo()">ğŸ“Š ç²å–ç¯€é»è³‡è¨Š</button>
            <button class="btn" onclick="fetchDelegatorInfo()">ğŸ‘¥ ç²å–å§”è¨—äººè³‡è¨Š</button>
        </div>

        <div id="status" class="status hidden">
            <div class="loading-spinner hidden" id="spinner"></div>
            <div id="status-text"></div>
        </div>

        <div class="dashboard">
            <div class="card" id="reward-card">
                <h3>
                    <div class="card-icon">ğŸ’°</div>
                    æœ€æ–°çå‹µè³‡è¨Š
                </h3>
                <div id="reward-info">
                    <div class="info-row">
                        <span class="info-label">ç‹€æ…‹:</span>
                        <span class="info-value">ç­‰å¾…è¼‰å…¥...</span>
                    </div>
                </div>
            </div>

            <div class="card" id="node-card">
                <h3>
                    <div class="card-icon">ğŸ–¥ï¸</div>
                    ç¯€é»è³‡è¨Š
                </h3>
                <div id="node-info">
                    <div class="info-row">
                        <span class="info-label">ç‹€æ…‹:</span>
                        <span class="info-value">ç­‰å¾…è¼‰å…¥...</span>
                    </div>
                </div>
            </div>

            <div class="card" id="delegator-card">
                <h3>
                    <div class="card-icon">ğŸ‘¥</div>
                    å§”è¨—äººè³‡è¨Š
                </h3>
                <div id="delegator-info">
                    <div class="info-row">
                        <span class="info-label">ç‹€æ…‹:</span>
                        <span class="info-value">ç­‰å¾…è¼‰å…¥...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="api-info">
            <h3>ğŸ”Œ APIç«¯é»è³‡è¨Š</h3>
            <p><strong>æœ¬åœ°çå‹µAPI:</strong></p>
            <div class="api-endpoint">GET http://localhost:8080/api/reward</div>
            
            <p><strong>Flowå€å¡ŠéˆAPI:</strong></p>
            <div class="api-endpoint">POST https://rest-mainnet.onflow.org/v1/scripts?blocks_height=final</div>
            
            <p><strong>ç›£æ§ç¯€é»ID:</strong></p>
            <div class="api-endpoint">e8f4bd649d08ecb5afb7023a0c5e8bb10ce56659399665da8cc9d517e7982f92</div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        const TWM_NODE_ID = "e8f4bd649d08ecb5afb7023a0c5e8bb10ce56659399665da8cc9d517e7982f92";
        const FLOW_API_URL = "https://rest-mainnet.onflow.org/v1/scripts?blocks_height=final";
        const LOCAL_REWARD_API = "http://localhost:8080/api/reward";

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            const spinner = document.getElementById('spinner');
            
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            statusText.textContent = message;
            
            if (type === 'loading') {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        // éš±è—ç‹€æ…‹è¨Šæ¯
        function hideStatus() {
            document.getElementById('status').classList.add('hidden');
        }

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            return parseFloat(num).toLocaleString('zh-TW', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 8
            });
        }

        // æ ¼å¼åŒ–ç¯€é»IDï¼ˆç¸®çŸ­é¡¯ç¤ºï¼‰
        function formatNodeId(nodeId) {
            return nodeId.substring(0, 8) + '...' + nodeId.substring(nodeId.length - 8);
        }

        // ç²å–æœ€æ–°çå‹µï¼ˆå¾æœ¬åœ°APIï¼‰
        async function fetchLatestReward() {
            showStatus('æ­£åœ¨ç²å–æœ€æ–°çå‹µè³‡è¨Š...', 'loading');
            
            try {
                const response = await fetch(LOCAL_REWARD_API);
                
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                displayRewardInfo(data);
                showStatus('çå‹µè³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('ç²å–çå‹µè³‡è¨Šå¤±æ•—:', error);
                showStatus(`ç²å–çå‹µå¤±æ•—: ${error.message}`, 'error');
                
                // å¦‚æœæœ¬åœ°APIå¤±æ•—ï¼Œé¡¯ç¤ºæ¨¡æ“¬æ•¸æ“š
                displayRewardInfo({
                    blockHeight: "æ¨¡æ“¬æ•¸æ“š",
                    nodeID: TWM_NODE_ID,
                    delegatorID: null,
                    amount: "123.45678901",
                    eventType: "A.8624b52f9ddcd04a.FlowIDTableStaking.RewardsPaid",
                    timestamp: new Date().toLocaleString('zh-TW')
                });
                
                setTimeout(hideStatus, 5000);
            }
        }

        // é¡¯ç¤ºçå‹µè³‡è¨Š
        function displayRewardInfo(data) {
            const rewardInfo = document.getElementById('reward-info');
            
            rewardInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">å€å¡Šé«˜åº¦:</span>
                    <span class="info-value">${data.blockHeight}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ç¯€é»ID:</span>
                    <span class="info-value node-id">${formatNodeId(data.nodeID)}</span>
                </div>
                ${data.delegatorID ? `
                <div class="info-row">
                    <span class="info-label">å§”è¨—äººID:</span>
                    <span class="info-value">${data.delegatorID}</span>
                </div>` : ''}
                <div class="info-row">
                    <span class="info-label">çå‹µé‡‘é¡:</span>
                    <span class="info-value amount">${formatNumber(data.amount)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">äº‹ä»¶é¡å‹:</span>
                    <span class="info-value">${data.eventType ? data.eventType.split('.').pop() : 'RewardsPaid'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ™‚é–“æˆ³:</span>
                    <span class="info-value">${data.timestamp || 'æœªçŸ¥'}</span>
                </div>
            `;
        }

        // ç²å–ç¯€é»è³‡è¨Š
        async function fetchNodeInfo() {
            showStatus('æ­£åœ¨ç²å–ç¯€é»è³‡è¨Š...', 'loading');
            
            try {
                const response = await fetch('http://localhost:8080/api/node');
                
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                displayNodeInfo(data);
                showStatus('ç¯€é»è³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('ç²å–ç¯€é»è³‡è¨Šå¤±æ•—:', error);
                showStatus(`ç²å–ç¯€é»è³‡è¨Šå¤±æ•—: ${error.message}`, 'error');
                
                // é¡¯ç¤ºæ¨¡æ“¬æ•¸æ“š
                displayNodeInfo({
                    value: {
                        id: TWM_NODE_ID,
                        networkingAddress: "ç¤ºä¾‹ç¶²è·¯åœ°å€",
                        networkingKey: "ç¤ºä¾‹ç¶²è·¯é‡‘é‘°",
                        role: 1,
                        tokensStaked: "500000.00000000",
                        tokensCommitted: "500000.00000000",
                        tokensUnstaking: "0.00000000",
                        tokensUnstaked: "0.00000000"
                    }
                });
                
                setTimeout(hideStatus, 5000);
            }
        }

        // é¡¯ç¤ºç¯€é»è³‡è¨Š
        function displayNodeInfo(data) {
            const nodeInfo = document.getElementById('node-info');
            const nodeData = data.value || data;
            
            nodeInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">ç¯€é»ID:</span>
                    <span class="info-value node-id">${formatNodeId(nodeData.id || TWM_NODE_ID)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">è§’è‰²:</span>
                    <span class="info-value">${nodeData.role || 'æœªçŸ¥'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å·²è³ªæŠ¼ä»£å¹£:</span>
                    <span class="info-value amount">${formatNumber(nodeData.tokensStaked || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ‰¿è«¾ä»£å¹£:</span>
                    <span class="info-value amount">${formatNumber(nodeData.tokensCommitted || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">è§£é™¤è³ªæŠ¼ä¸­:</span>
                    <span class="info-value amount">${formatNumber(nodeData.tokensUnstaking || 0)} FLOW</span>
                </div>
            `;
        }

        // ç²å–å§”è¨—äººè³‡è¨Š
        async function fetchDelegatorInfo() {
            showStatus('æ­£åœ¨ç²å–å§”è¨—äººè³‡è¨Š...', 'loading');
            
            try {
                const response = await fetch('http://localhost:8080/api/delegator');
                
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                displayDelegatorInfo(data);
                showStatus('å§”è¨—äººè³‡è¨Šæ›´æ–°æˆåŠŸï¼', 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                console.error('ç²å–å§”è¨—äººè³‡è¨Šå¤±æ•—:', error);
                showStatus(`ç²å–å§”è¨—äººè³‡è¨Šå¤±æ•—: ${error.message}`, 'error');
                
                // é¡¯ç¤ºæ¨¡æ“¬æ•¸æ“š
                displayDelegatorInfo({
                    value: {
                        id: 1,
                        nodeID: TWM_NODE_ID,
                        tokensCommitted: "1000.00000000",
                        tokensStaked: "1000.00000000",
                        tokensUnstaking: "0.00000000",
                        tokensUnstaked: "0.00000000",
                        tokensRewarded: "50.12345678"
                    }
                });
                
                setTimeout(hideStatus, 5000);
            }
        }

        // é¡¯ç¤ºå§”è¨—äººè³‡è¨Š
        function displayDelegatorInfo(data) {
            const delegatorInfo = document.getElementById('delegator-info');
            const delegatorData = data.value || data;
            
            delegatorInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">å§”è¨—äººID:</span>
                    <span class="info-value">${delegatorData.id || '1'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ç›®æ¨™ç¯€é»:</span>
                    <span class="info-value node-id">${formatNodeId(delegatorData.nodeID || TWM_NODE_ID)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ‰¿è«¾ä»£å¹£:</span>
                    <span class="info-value amount">${formatNumber(delegatorData.tokensCommitted || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å·²è³ªæŠ¼ä»£å¹£:</span>
                    <span class="info-value amount">${formatNumber(delegatorData.tokensStaked || 0)} FLOW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ç´¯è¨ˆçå‹µ:</span>
                    <span class="info-value amount">${formatNumber(delegatorData.tokensRewarded || 0)} FLOW</span>
                </div>
            `;
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•ç²å–çå‹µè³‡è¨Š
        window.addEventListener('load', () => {
            fetchLatestReward();
        });

        // æ¯30ç§’è‡ªå‹•åˆ·æ–°çå‹µè³‡è¨Š
        setInterval(fetchLatestReward, 30000);
    </script>
</body>
</html>